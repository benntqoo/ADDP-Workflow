---
arguments: optional
format: "[up|down|status|force|rollback]"
examples:
  - "/sync - 执行双向同步（智能判断）"
  - "/sync up - 上传本地修改到远程"
  - "/sync down - 下载远程更新到本地"
  - "/sync status - 查看同步状态"
  - "/sync force - 强制同步（覆盖冲突）"
  - "/sync rollback - 回滚到上一版本"
---

Claude 宪法双向同步系统：

## 🔄 智能同步机制

### 1. 同步状态检测
- **版本比对**
  - 本地 CLAUDE.md 版本
  - 远程模板版本
  - LOCAL 标记区域变化
  - 最后同步时间戳

- **冲突检测**
  - 标准部分的冲突
  - LOCAL 区域保护
  - 自定义规则冲突
  - 版本不兼容警告

### 2. 双向同步策略

#### 上传同步（本地 → 远程）
```yaml
同步内容:
  - LOCAL 区域的项目特定配置
  - 自定义命令和规则
  - 项目词汇表更新
  - 最佳实践积累

保护机制:
  - 备份远程版本
  - 变更确认提示
  - 回滚能力保证
```

#### 下载同步（远程 → 本地）
```yaml
更新内容:
  - 宪法模板最新版本
  - 新增的标准功能
  - 修复的已知问题
  - 优化的工作流程

保护机制:
  - LOCAL 区域不受影响
  - 自动合并非冲突更新
  - 冲突时提供选择
```

### 3. 冲突解决

#### 自动解决
- 非冲突区域自动合并
- LOCAL 标记内容优先保留
- 版本号自动更新
- 时间戳自动记录

#### 手动解决
```diff
发现冲突时会显示：
<<<<<<< LOCAL
您的本地配置
=======
远程模板配置
>>>>>>> REMOTE

选择选项：
1. 保留本地版本
2. 使用远程版本
3. 手动编辑合并
4. 查看详细差异
```

### 4. 版本历史追踪

#### 同步记录
```yaml
sync_history:
  - timestamp: "2024-01-15T10:30:00Z"
    action: "download"
    from_version: "1.0.0"
    to_version: "2.0.0"
    changes: ["新增功能", "修复问题"]
    
  - timestamp: "2024-01-14T15:20:00Z"
    action: "upload"
    content: "项目特定规则"
    status: "success"
```

#### 回滚能力
- 保存最近 10 个版本
- 一键回滚到任意版本
- 查看版本间差异
- 恢复误删内容

## 📡 与团队协作

### 共享配置
- **导出项目配置**
  ```bash
  /sync export --format team
  # 生成可分享的配置包
  ```

- **导入团队配置**
  ```bash
  /sync import team-config.json
  # 应用团队统一配置
  ```

### 配置中心集成
- Git 仓库同步
- 配置服务器支持
- 团队配置继承
- 权限控制机制

## 🛡️ 安全机制

### 备份策略
1. **自动备份**
   - 每次同步前备份
   - 保存到 `.claude/backups/`
   - 自动清理旧备份

2. **手动备份**
   ```bash
   /sync backup --name "重要更改前"
   ```

### 验证机制
- 配置语法检查
- 规则有效性验证
- 依赖完整性检查
- 签名验证（如启用）

## 📊 同步报告

### 状态概览
```yaml
同步状态:
  本地版本: 2.0.0
  远程版本: 2.1.0
  最后同步: 2天前
  待同步项: 3
  
  冲突项:
    - 工作流程定义
    - 自动化配置
```

### 变更预览
- 即将添加的功能
- 即将更新的配置
- 可能的影响范围
- 建议的操作步骤

## 🔧 高级功能

### 选择性同步
```bash
/sync --only "工作流,命令"
# 只同步特定部分
```

### 定时同步
```bash
/sync schedule --daily
# 设置每日自动检查更新
```

### 同步钩子
```yaml
hooks:
  pre_sync: "npm test"
  post_sync: "npm run build"
  on_conflict: "notify-team"
```

## 💡 最佳实践

1. **定期同步**
   - 每周检查更新
   - 重要更改前同步
   - 团队统一同步时间

2. **谨慎操作**
   - 同步前查看状态
   - 理解变更影响
   - 保留备份习惯

3. **团队协作**
   - 共享项目配置
   - 记录自定义原因
   - 及时沟通变更